name: build-feature

on: workflow_dispatch

env:
  ARCH_KEYSTORE: ${{ secrets.ARCHIVED_KEYSTORE }}
  KEY_PASS: ${{ secrets.KEY_PASS }}
  KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
  # These vars contain files which are reused between steps.
  BUNDLE_TOOL: bundletool.jar
  KEYSTORE: keystore

jobs:
  # Builds release bundle.
  build-bundle:
    uses: ./.github/workflows/build-bundle.yml

  generate-apk:
    runs-on: ubuntu-latest
    needs: [build-bundle]
    steps:

      # Download Java runtime to run bundle tool.
      # Executed first because otherwise may cause troubles as it cleans working directory from any untracked files
      # (executes git clean with some flags). We can prevent it by adding "clean: false".
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'liberica'
          java-package: 'jre'

      - name: Checkout branch
        uses: actions/checkout@v3
      - name: Download built bundle
        uses: actions/download-artifact@v3
        with:
          name: app-release.aab
          path: .


      - name: Download Bundle Tool
        # Single command written in multiline manner.
        # -4 dictates to use only IPv4. -L dictates to redo request if resource was moved.
        run: |
          curl \
            'https://github.com/google/bundletool/releases/download/1.8.1/bundletool-all-1.8.1.jar' \
            -4 \
            -sL \
            -o "$BUNDLE_TOOL"

      - name: Get keystore
        run: |
          encodedZipFile="encodedKey.txt"
          echo $ARCH_KEYSTORE > "$encodedZipFile"
          ./secret_parser.sh -d "$encodedZipFile" "$KEYSTORE"

      - name: Generate apk file
        run: |
          universalApk=release_app.apk
          apksFile="app.apks"
          java -jar "$BUNDLE_TOOL" build-apks \
            --mode=universal \
            --local-testing \
            --bundle app-release.aab \
            --output "$apksFile" \
            --ks="$KEYSTORE" \
            --ks-pass=pass:"$KEY_PASS" \
            --ks-key-alias="$KEY_ALIAS" \
            --key-pass=pass:"$KEY_PASS"
          unzip -p "$apksFile" universal.apk > $universalApk

      - name: Upload universal apk to GitHub
        uses: actions/upload-artifact@v3
        with:
          name: release-app.apk
          path: release_app.apk